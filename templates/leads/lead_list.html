{% extends 'base.html' %}

{% block title %}Lead List - CRM Django{% endblock %}

{% block extra_css %}{% endblock %}

{% block content %}
{% if messages %}
<div class="ui messages">
    {% for message in messages %}
    <div class="ui {{ message.tags }} message">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

<div class="ui stackable grid">
    <div class="ten wide column">
        <h2 class="ui header">Lead Management</h2>
    </div>
    <div class="six wide column right aligned">
            <form method="post" action="{% url 'leads:recalculate_scores' %}" style="display: inline;">
                {% csrf_token %}
                <input type="hidden" name="next" value="{% url 'leads:lead_list' %}">
                <button type="submit" class="ui orange button"><i class="sync icon"></i> Recalculate Score</button>
            </form>
            <a href="{% url 'leads:lead_create' %}" class="ui primary button">+ New Lead</a>
            <form method="post" action="{% url 'leads:clear_leads' %}" style="display: inline;" onsubmit="return confirm('⚠️ WARNING: This will permanently delete ALL leads and companies. This action cannot be undone. Are you absolutely sure?');">
                {% csrf_token %}
                <button type="submit" class="ui red button">Clear All</button>
            </form>
    </div>
</div>

<div class="ui segment" style="padding: 0;">
    <form method="get" action="{% url 'leads:lead_list' %}" class="ui form" style="margin: 0;">
        <div class="field">
            <div class="ui action input fluid">
                <input type="text" name="search" value="{{ search_query }}" placeholder="Search leads by name, email, or company...">
                <button type="submit" class="ui button">Search</button>
                {% if search_query %}
                <a href="{% url 'leads:lead_list' %}" class="ui button">Clear</a>
                {% endif %}
            </div>
        </div>
    </form>
</div>

<div class="ui small statistics">
    <div class="statistic">
        <div class="value">{{ leads|length }}</div>
        <div class="label">Total Leads</div>
    </div>
    <div class="statistic">
        <div class="value">{{ leads|length }}</div>
        <div class="label">Active Leads</div>
    </div>
    <div class="statistic">
        <div class="value">{{ avg_score }}</div>
        <div class="label">Average Score</div>
    </div>
</div>

{% if leads %}
<div class="ui segment" style="padding: 0;">
    <table class="ui celled striped table" style="margin: 0;">
        <thead>
            <tr>
                <th>Email</th>
                <th>Company</th>
                <th>Score</th>
                <th>Stage</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for lead in leads %}
            <tr>
                <td>{{ lead.email }}</td>
                <td>{{ lead.company.company_name|default:lead.company.domain }}</td>
                <td><strong>{{ lead.lead_score }}</strong></td>
                <td>
                    {% if lead.lead_stage %}
                        {% if lead.lead_stage == 'low' %}
                            <span class="ui teal label">{{ lead.get_lead_stage_display }}</span>
                        {% elif lead.lead_stage == 'medium' %}
                            <span class="ui yellow label">{{ lead.get_lead_stage_display }}</span>
                        {% elif lead.lead_stage == 'high' %}
                            <span class="ui orange label">{{ lead.get_lead_stage_display }}</span>
                        {% elif lead.lead_stage == 'very_high' %}
                            <span class="ui red label">{{ lead.get_lead_stage_display }}</span>
                        {% else %}
                            <span class="ui green label">{{ lead.get_lead_stage_display }}</span>
                        {% endif %}
                    {% else %}-{% endif %}
                </td>
                <td>
                    {% if lead.email_status == 'active' %}
                        <span class="ui green label">{{ lead.get_email_status_display }}</span>
                    {% elif lead.email_status == 'bounced' %}
                        <span class="ui red label">{{ lead.get_email_status_display }}</span>
                    {% else %}
                        <span class="ui grey label">{{ lead.get_email_status_display }}</span>
                    {% endif %}
                </td>
                <td>
                    <div class="ui small buttons">
                        <a href="{% url 'leads:lead_detail' lead.email %}" class="ui button">View</a>
                        <a href="{% url 'leads:lead_update' lead.email %}" class="ui button">Edit</a>
                        <a href="{% url 'leads:lead_delete' lead.email %}" class="ui red button">Delete</a>
                    </div>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>
{% else %}
<div class="ui placeholder segment">
    <div class="ui icon header">
        <i class="users icon"></i>
        No leads registered
    </div>
    <a href="{% url 'leads:lead_create' %}" class="ui primary button">+ Create First Lead</a>
</div>
{% endif %}
{% endblock %}

{% block extra_js %}
<div class="ui modal" id="lead-enrich-modal">
    <div class="header">Enrich leads</div>
    <div class="content">Do you want to re-enrich existing fields too?</div>
    <div class="actions">
        <button class="ui button" onclick="runLeadEnrichment('empty')">Only empty fields</button>
        <button class="ui primary button" onclick="runLeadEnrichment('all')">Re-enrich all</button>
    </div>
</div>

<script>
    function openLeadEnrichModal() {
        $('#lead-enrich-modal').modal('show');
        return false;
    }

    function runLeadEnrichment(mode) {
        window.location.href = "{% url 'leads:lead_enrich' %}?mode=" + mode;
    }
</script>
{% endblock %}
